version: "1.0"

forward-flows:
  user-registration-flow:
    description: "Flow đăng ký người dùng và gửi email xác nhận"
    steps:
      - name: "create-user"
        command: "create-user.command"
        fireAndForget:
          - "audit.log.userCreated"
          - "analytics.track.userRegistration"
        onSuccess:
          next: "send-welcome-email"
          emit: "create-user.success"
        onFailure:
          next: "user-registration-rollback-flow"
          emit: "create-user.failed"
      
      - name: "send-welcome-email"
        command: "send-welcome-email.command"
        fireAndForget:
          - "log.emailSentAttempt"
        onSuccess:
          emit: "send-welcome-email.success"
        onFailure:
          emit: "send-welcome-email.failed"

  order-payment-flow:
    description: "Flow tạo đơn hàng, trừ tồn kho, thanh toán"
    steps:
      - name: "create-order"
        command: "create-order.command"
        fireAndForget:
          - "audit.log.orderCreated"
          - "notification.push.orderCreated"
        onSuccess:
          next: "reserve-inventory"
          emit: "create-order.success"
        onFailure:
          next: "rollback-flow.order-payment-rollback-flow"
          emit: "create-order.failed"
      
      - name: "reserve-inventory"
        command: "reserve-inventory.command"
        fireAndForget:
          - "log.inventoryReservationStarted"
        onSuccess:
          emit: "reserve-inventory.success"
        onFailure:
          next: "rollback-flow.order-payment-rollback-flow"
          emit: "reserve-inventory.failed"

rollback-flows:
  user-registration-rollback-flow:
    description: "Flow hoàn tác đăng ký người dùng"
    steps:
      - name: "rollback-user"
        command: "rollback-user.command"
        fireAndForget:
        - "audit.log.userRollback"
        onSuccess:
         emit: "rollback-user.success"
        onFailure:
         emit: "rollback-user.failed"
    
  order-payment-rollback-flow:
    description: "Flow hoàn tác đơn hàng và tồn kho"
    steps:
      - name: "rollback-order"
        command: "rollback-order.command"
        fireAndForget:
        - "audit.log.orderRollback"
        onSuccess:
          next: "rollback-inventory"
          emit: "rollback-order.success"
        onFailure:
          emit: "rollback-order.failed"

      - name: "rollback-inventory"
        command: "rollback-inventory.command"
        fireAndForget:
          - "audit.log.inventoryRollback"
        onSuccess:
          emit: "rollback-inventory.success"
        onFailure:
          emit: "rollback-inventory.failed"
